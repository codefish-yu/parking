<!-- 有车牌的车辆 -->

<!DOCTYPE html>
<html>
<head>
	<title>出场</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
	<h3>账 单: </h3>
	<h5>车牌号: {{ record.car_number }}</h5>
	<h5>入场时间: {{ record.in_time|date:'Y-m-d H:i:s'}}</h5>
	<h5>出场时间: {{ record.out_time|date:'Y-m-d H:i:s'}}</h5>
	 
	<input type="hidden" name='action' value='leave' />
	<input type="hidden" name='id' value='{{ r.id }}' />
	<h6> 友情提醒: 支付后 15 分钟内未出场, 将会照常收取滞留费 </h6>
	<input type="button" id='pay-btn' value='支付' style='width: 100px;' 
	product_id='{{product.id}}' />
</body>
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>

<script type="text/javascript">
	var parkinglot_id = {{ parkinglot_id }}

	var product_id = {{product.id}}

	function myajax(url, data, callback, type){
            type = type || 'json'
            $.ajax({
                url: url, 
                data: data,
                type: 'post',
                dataType: type,
                success: callback
            })
        }

	$('#pay-btn').click(function(){
		
		myajax('/order/public/account/'+product_id+'/', {csrfmiddlewaretoken:'{{ csrf_token }}'}, (data)=>{
			pay(data)
		})
	})

	
	function pay(data){
	   WeixinJSBridge.invoke(
	      'getBrandWCPayRequest', {
	      	"appId":data.appId,     //公众号名称，由商户传入     
	         "timeStamp":data.timeStamp,         //时间戳，自1970年以来的秒数     
	         "nonceStr":data.nonceStr, //随机串     
	         "package":data.package,     
	         "signType":data.signType,         //微信签名方式：     
	         "paySign":data.paySign 	//微信签名 
	         // "appId":"wx2421b1c4370ec43b",     //公众号名称，由商户传入     
	         // "timeStamp":"1395712654",         //时间戳，自1970年以来的秒数     
	         // "nonceStr":"e61463f8efa94090b1f366cccfbbb444", //随机串     
	         // "package":"prepay_id=u802345jgfjsdfgsdg888",     
	         // "signType":"MD5",         //微信签名方式：     
	         // "paySign":"70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名 
	      },
	      function(res){
		      if(res.err_msg == "get_brand_wcpay_request:ok" ){
		      	var xx = setInterval(function(){
			      	myajax('/wechat/leave/'+parkinglot_id+'/', 
			      		{
			      			csrfmiddlewaretoken:'{{ csrf_token }}',
			      		 	product_id: product_id,
			      		 	action: 'payconfirm'
			      		}, (data)=>{
						if(data.success){
							clearInterval(xx)
						}
					})
				},500)
		        // 使用以上方式判断前端返回,微信团队郑重提示：
		        // res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
		      } else{
		      	alert('支付失败')
		      	console.info(res)
		      }
		
	   }); 
	}
	// if (typeof WeixinJSBridge == "undefined"){
	//    if( document.addEventListener ){
	//        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
	//    }else if (document.attachEvent){
	//        document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
	//        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
	//    }
	// }else{
	//    onBridgeReady();
	// }
</script>


</html>
